#!/usr/bin/env groovy

//@Library("com.optum.jenkins.pipeline.library@master") _
@Library("com.optum.jenkins.pipeline.library@v0.1.24") _

String dockerHost = 'docker.repo1.uhc.com'
String namespace = 'uhcinsights'
String tagBase = "$dockerHost/$namespace"

pipeline {
    agent none
    environment {
        DOCKER_CREDENTIALS_ID = 'deploy_id'
        OPENSHIFT_CREDENTIALS_ID = 'deploy_id'
        DEVOPS_METRICS_ENABLED = 'false'
        SONAR_CREDENTIALS_ID = 'Sonar_ID'
        NPM_ID = 'npm_id'
        NODEJS_VERSION = '7.9.0'
    }

    stages {

        /**stage('Run Sonar Scan for UI') {
            agent {
                label 'docker-kitchensink-slave'
            }
            steps {
                withCredentials([string(credentialsId:"${env.NPM_ID}", variable:'NPM_AUTH_KEY')]){
                    command """
                    export NPM_AUTH_KEY="ped"
                    export NPM_EMAIL="email"
                    npm install
                    """
                    }
               glSonarNpmScan gitUserCredentialsId:"${env.SONAR_CREDENTIALS_ID}",
               additionalProps:['sonar.sources':'src', 'sonar.javascript.lcov.reportPath':'coverage/lcov.info', 'sonar.ts.lcov.reportpath':'coverage/lcov.info']

            }
        }**/

        stage('Web: Build and Deploy Docker Image to DTR') {
            agent {
                label 'docker-nodejs-slave'
            }
            steps {
                glDockerImageBuildPush tag: "$tagBase/ui_prd",
                   dockerHost: 'docker.repo1.uhc.com',
                   dockerCredentialsId: "$env.DOCKER_CREDENTIALS_ID",
                   extraBuildOptions: "--build-arg env_var=externalprod"
          
                glDockerImageBuildPush tag: "$tagBase/ui_prd_internal:pedui2",
                   dockerHost: 'docker.repo1.uhc.com',
                   dockerCredentialsId: "$env.DOCKER_CREDENTIALS_ID",
                   extraBuildOptions: "--build-arg env_var=prod"
          
                glDockerImageTag sourceTag: "$tagBase/ui_prd:latest",
                         destTag: "$tagBase/ui_prd:${env.BUILD_NUMBER}"
                         
                glDockerImagePush dockerCredentialsId: "${env.DOCKER_CREDENTIALS_ID}", 
                     tag:"$tagBase/ui_prd:${env.BUILD_NUMBER}",
                     dockerHost: 'docker.repo1.uhc.com'
                     
                glDockerImageTag sourceTag: "$tagBase/ui_prd_internal:pedui2",
                         destTag: "$tagBase/ui_prd_internal:${env.BUILD_NUMBER}"
                         
                glDockerImagePush dockerCredentialsId: "${env.DOCKER_CREDENTIALS_ID}", 
                     tag:"$tagBase/ui_prd_internal:${env.BUILD_NUMBER}",
                     dockerHost: 'docker.repo1.uhc.com'
            }
        }

        stage('OSE Deployment Web Prod') {
        agent {
                label 'docker-maven-slave'
            }
            steps {
                glOpenshiftDeploy credentials: "$env.OPENSHIFT_CREDENTIALS_ID",
                        ocpUrl: "https://ocp-elr-dmz.optum.com",
                        project: 'pedprd',
                        serviceName: 'peduiuhc',
                        dockerImage: '$tagBase/ui_prd:latest',
                        port: '8000'

            }
        }

       stage('OSE Deployment Web DR') {
       agent {
                label 'docker-maven-slave'
            }
            steps {
                glOpenshiftDeploy credentials: "$env.OPENSHIFT_CREDENTIALS_ID",
                        ocpUrl: "https://ocp-ctc-dmz.optum.com",
                        project: 'pedprddr',
                        serviceName: 'peduiuhc',
                        dockerImage: '$tagBase/ui_prd:latest',
                        port: '8000'
                glOpenshiftDeploy credentials: "$env.OPENSHIFT_CREDENTIALS_ID",
                        ocpUrl: "https://ocp-ctc-core.optum.com",
                        project: 'ped-internal',
                        serviceName: 'pedui2',
                        dockerImage: '$tagBase/ui_prd_internal:pedui2',
                        port: '8000'

            }
        }
    }

    post {
        always {
            echo 'Email Notification'
            emailext body: "UI release deployment is completed with $currentBuild.currentResult \n\n" +
                    "Please check following production projects for more details \n" +
                    "Prd Url: https://ocp-elr-dmz.optum.com \n" +
                    "Dr Url: https://ocp-ctc-dmz.optum.com \n\n" +
                    "If connection to app is refused, please give a few minutes for pods to fully deploy in OpenShift",
                    subject: "$currentBuild.currentResult-PRD UI Deployment",
                    to: 'myinsights_devops_DL@ds.uhc.com'

        }
    }

}
