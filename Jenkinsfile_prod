#!/usr/bin/env groovy

//@Library("com.optum.jenkins.pipeline.library@master") _
@Library("com.optum.jenkins.pipeline.library@v0.1.24") _

String dockerHost = 'docker.optum.com'
String webRepo = 'pedweb_prd'
String namespace = 'fspeddeply'
String webuiDir = 'webui'
String tagBase = "$dockerHost/$namespace"

pipeline {
    agent none
    environment {
        DOCKER_CREDENTIALS_ID = 'deploy_id'
        OPENSHIFT_CREDENTIALS_ID = 'deploy_id'
        DEVOPS_METRICS_ENABLED = 'false'
        SONAR_CREDENTIALS_ID = 'Sonar_ID'
        NPM_ID = 'npm_id'
        NODEJS_VERSION = '7.9.0'
    }

    stages {
        
        stage('Web: Build and Deploy Docker Image to DTR') {
            agent {
                label 'docker-kitchensink-slave'
            }
            steps {
                glDockerImageBuildPush tag: "$tagBase/$webRepo:pedui2",
                        repository: "$webRepo",
                        namespace: "$namespace",
                        dockerCredentialsId: "$env.DOCKER_CREDENTIALS_ID",
                        extraBuildOptions: "--build-arg env_var=prod"
            }
        }
        
       stage('OSE Deployment Web') {
       agent {
                label 'docker-maven-slave'
            }
            steps {
                glOpenshiftDeploy credentials: "$env.OPENSHIFT_CREDENTIALS_ID",
                        ocpUrl: "https://ocp-ctc-core.optum.com",
                        project: 'ped-internal',
                        serviceName: 'pedui2',
                        dockerImage: 'docker.optum.com/fspeddeply/pedweb_prd:pedui2',
                        port: '8000'

            }
        }    
    }

    post {
        always {
            echo 'Email Notification'
            emailext body: "Release deployment for new UI is completed with $currentBuild.currentResult \n\n" +
                    "Please check following production projects for more details \n" +
                    "Prd Url: https://ocp-ctc-core.optum.com \n" +
                    "If connection to app is refused, please give a few minutes for pods to fully deploy in OpenShift",
                    subject: "$currentBuild.currentResult-PRD UI Deployment",
                    to: 'myinsights_devops_DL@ds.uhc.com'
        }
    }

}
